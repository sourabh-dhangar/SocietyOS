name: Deploy SocietyOS to Hostinger

on:
  push:
    branches:
      - main

jobs:
  deploy:
    name: Deploy to VPS
    runs-on: ubuntu-latest

    steps:
      - name: Execute Remote SSH Commands
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: 213.210.37.34
          username: root
          key: ${{ secrets.SERVER_SSH_KEY }}
          script: |
            echo "Starting Deployment Process..."

            # Navigate to directory or clone if it doesn't exist
            if [ -d "/var/www/SocietyOS" ]; then
              echo "Repository exists. Pulling latest changes..."
              cd /var/www/SocietyOS
              git reset --hard HEAD
              git pull origin main
            else
              echo "Repository does not exist. Cloning..."
              git clone https://github.com/sourabh-dhangar/SocietyOS.git /var/www/SocietyOS
              cd /var/www/SocietyOS
            fi

            echo "Setting up environment variables..."
            cat > .env << 'EOF'
            MONGO_URI=${{ secrets.MONGO_URI }}
            JWT_SECRET=${{ secrets.JWT_SECRET }}
            SUPER_ADMIN_EMAIL=${{ secrets.SUPER_ADMIN_EMAIL }}
            SUPER_ADMIN_PASSWORD=${{ secrets.SUPER_ADMIN_PASSWORD }}
            SUPER_ADMIN_PHONE=${{ secrets.SUPER_ADMIN_PHONE }}
            PORT=5005
            NODE_ENV=production
            EOF
            # Remove leading whitespace from heredoc
            sed -i 's/^[[:space:]]*//' .env

            echo "Rebuilding Docker containers..."
            cd /var/www/SocietyOS
            docker-compose down
            docker-compose up -d --build

            echo "Cleaning up dangling images to save space..."
            docker image prune -f

            echo "Deployment Successful! Application running on port 5005."
