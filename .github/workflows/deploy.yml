name: Deploy SocietyOS to Hostinger

on:
  push:
    branches:
      - main

jobs:
  deploy:
    name: Deploy to VPS
    runs-on: ubuntu-latest

    steps:
      - name: Execute Remote SSH Commands
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: 213.210.37.34
          username: root
          key: ${{ secrets.SERVER_SSH_KEY }}
          script: |
            echo "Starting Deployment Process..."

            # Navigate to directory or clone if it doesn't exist
            if [ -d "~/SocietyOS" ]; then
              echo "Repository exists. Pulling latest changes..."
              cd ~/SocietyOS
              # Discard any local tracking changes that might conflict
              git reset --hard HEAD
              git pull origin main
            else
              echo "Repository does not exist. Cloning..."
              git clone https://github.com/sourabh-dhangar/SocietyOS.git ~/SocietyOS
              cd ~/SocietyOS
            fi

            echo "Setting up environment variables..."
            # Create .env file for docker-compose based on GitHub Secrets
            echo "MONGO_URI=${{ secrets.MONGO_URI }}" > .env
            echo "JWT_SECRET=${{ secrets.JWT_SECRET }}" >> .env
            echo "ADMIN_EMAIL=${{ secrets.ADMIN_EMAIL }}" >> .env
            echo "ADMIN_PASSWORD=${{ secrets.ADMIN_PASSWORD }}" >> .env
            echo "ADMIN_PHONE=${{ secrets.ADMIN_PHONE }}" >> .env

            echo "Rebuilding Docker containers..."
            # Stop existing containers, rebuild images, and start
            docker compose down
            docker compose up -d --build

            echo "Cleaning up dangling images to save space..."
            docker image prune -f

            echo "Deployment Successful! Application running on port 5005."
